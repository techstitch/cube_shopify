{% comment %}
  Renders product variant-picker

  Accepts:
  - product: {Object} product object.
  - block: {Object} passing the block information.
  - product_form_id: {String} Id of the product form to which the variant picker is associated.
  Usage:
  {% render 'product-variant-picker', product: product, block: block, product_form_id: product_form_id %}
{% endcomment %}
{% comment %}
  {%- unless product.has_only_default_variant -%}
    <variant-selects
      id="variant-selects-{{ section.id }}"
      data-section="{{ section.id }}"
      {{ block.shopify_attributes }}
    >
      {%- for option in product.options_with_values -%}
        {%- liquid
          assign swatch_count = option.values | map: 'swatch' | compact | size
          assign picker_type = block.settings.picker_type

          if swatch_count > 0 and block.settings.swatch_shape != 'none'
            if block.settings.picker_type == 'dropdown'
              assign picker_type = 'swatch_dropdown'
            else
              assign picker_type = 'swatch'
            endif
          endif
        -%}
        {%- if picker_type == 'swatch' -%}
          <fieldset class="js product-form__input product-form__input--swatch">
            <legend class="form__label">
              {{ option.name }}:
              <span data-selected-value>
                {{- option.selected_value -}}
              </span>
            </legend>
            {% render 'product-variant-options',
              product: product,
              option: option,
              block: block,
              picker_type: picker_type
            %}
          </fieldset>
        {%- elsif picker_type == 'button' -%}
          <fieldset class="js product-form__input product-form__input--pill">
            <legend class="form__label">{{ option.name }}</legend>
            {% render 'product-variant-options',
              product: product,
              option: option,
              block: block,
              picker_type: picker_type
            %}
          </fieldset>
        {%- else -%}
          <div class="product-form__input product-form__input--dropdown">
            <label class="form__label" for="Option-{{ section.id }}-{{ forloop.index0 }}">
              {{ option.name }}
            </label>
            <div class="select">
              {%- if picker_type == 'swatch_dropdown' -%}
                <span
                  data-selected-value
                  class="dropdown-swatch"
                >
                  {% render 'swatch', swatch: option.selected_value.swatch, shape: block.settings.swatch_shape %}
                </span>
              {%- endif -%}
              <select
                id="Option-{{ section.id }}-{{ forloop.index0 }}"
                class="select__select"
                name="options[{{ option.name | escape }}]"
                form="{{ product_form_id }}"
              >
                {% render 'product-variant-options',
                  product: product,
                  option: option,
                  block: block,
                  picker_type: picker_type
                %}
              </select>
              <span class="svg-wrapper">
                {{- 'icon-caret.svg' | inline_asset_content -}}
              </span>
            </div>
          </div>
        {%- endif -%}
      {%- endfor -%}

      <script type="application/json" data-selected-variant>
        {{ product.selected_or_first_available_variant | json }}
      </script>
    </variant-selects>
  {%- endunless -%}
{% endcomment %}
{% comment %}
  Custom Variant Picker for Subscription Products (based on Figma design)
  Assumes options: Subscription type (Single/Double), Flavour (Chocolate, Vanilla, Orange)
{% endcomment %}
<form method="post" action="/cart/add" id="custom-subscription-form">
  <div class="subscription-cards">
    {% assign single_features = product.metafields.content.single_drink_subscription_features %}
    {% assign double_features = product.metafields.content.double_drink_subscription_features %}

    {% for option in product.options_with_values[0].values %}
      {% assign current_variant = product.variants | where: 'option1', option | first %}
      <div class="subscription-card-wrapper">
        <label class="subscription-card">
          <input
            type="radio"
            name="subscription_type"
            value="{{ option }}"
            {% if forloop.first %}
              checked
            {% endif %}
          >
          <div class="subscription-card-inner">
            {% comment %}
              <div class="subscription-card-image">
                {% if current_variant.featured_image %}
                  <img src="{{ current_variant.featured_image | image_url: width: 300 }}" alt="{{ option }}">
                {% endif %}
              </div>
            {% endcomment %}
            <div class="subscription-card-title">
              {{ option }}
            </div>
            <div class="subscription-card-price">
              {{ current_variant.price | money }}
              <s>{{ current_variant.compare_at_price | money }}</s>
            </div>
          </div>
        </label>
        <div class="subscription-details" style="display: {% if forloop.first %}block{% else %}none{% endif %};">
          <div class="flavour-picker">
            {% if option == 'Double Drink Subscription' %}
              <h4>Choose Flavor 1</h4>
              <div class="flavour-options">
                {% for flavor in product.options_with_values[1].values %}
                  <label class="flavour-card">
                    <input
                      type="radio"
                      name="flavour1"
                      value="{{ flavor }}"
                      {% if forloop.first %}
                        checked
                      {% endif %}
                    >
                    <div class="flavour-thumbnail">
                      {% assign v = product.variants | where: 'option1', option | where: 'option2', flavor | first %}
                      {% if v.featured_image %}
                        <img src="{{ v.featured_image | image_url: width: 100 }}" alt="{{ flavor }}">
                      {% endif %}
                    </div>
                    <span>{{ flavor }}</span>
                  </label>
                {% endfor %}
              </div>
              <h4>Choose Flavor 2</h4>
              <div class="flavour-options">
                {% for flavor in product.options_with_values[1].values %}
                  <label class="flavour-card">
                    <input
                      type="radio"
                      name="flavour2"
                      value="{{ flavor }}"
                      {% if forloop.first %}
                        checked
                      {% endif %}
                    >
                    <div class="flavour-thumbnail">
                      {% assign v = product.variants | where: 'option1', option | where: 'option2', flavor | first %}
                      {% if v.featured_image %}
                        <img src="{{ v.featured_image | image_url: width: 100 }}" alt="{{ flavor }}">
                      {% endif %}
                    </div>
                    <span>{{ flavor }}</span>
                  </label>
                {% endfor %}
              </div>
            {% else %}
              <h4>Choose Flavor</h4>
              <div class="flavour-options">
                {% for flavor in product.options_with_values[1].values %}
                  <label class="flavour-card">
                    <input
                      type="radio"
                      name="flavour1"
                      value="{{ flavor }}"
                      {% if forloop.first %}
                        checked
                      {% endif %}
                    >
                    <div class="flavour-thumbnail">
                      {% assign v = product.variants | where: 'option1', option | where: 'option2', flavor | first %}
                      {% if v.featured_image %}
                        <img src="{{ v.featured_image | image_url: width: 100 }}" alt="{{ flavor }}">
                      {% endif %}
                    </div>
                    <span>{{ flavor }}</span>
                  </label>
                {% endfor %}
              </div>
            {% endif %}
          </div>

          <div class="whats-included">
            <p>What's included:</p>
            <div class="included-block">
              <h5>Every 30 Days</h5>
              <img src="{{ 'every30.png' | asset_url }}">
            </div>
            <div class="included-block">
              <h5>One Time <span class="free">(Free)</span></h5>
              <div class="preview-bottles">
                {% for flavor in product.options_with_values[1].values %}
                  {% assign v = product.variants | where: 'option1', option | where: 'option2', flavor | first %}
                  {% if v.featured_image %}
                    <img src="{{ v.featured_image | image_url: width: 60 }}" alt="{{ flavor }}">
                  {% endif %}
                {% endfor %}
              </div>
            </div>
            <ul class="features">
              {% if option == 'Single Drink Subscription' %}
                {% assign feature_items = single_features %}
              {% else %}
                {% assign feature_items = double_features %}
              {% endif %}
              {% for feature in feature_items %}
                <li>
                  <strong>{{ feature }}</strong>
                </li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <div id="variant-id-container"></div>
  <button type="submit">Add to Cart</button>
</form>

<script>
  const variants = {{ product.variants | json }};

  function updateVariantID() {
    const type = document.querySelector('input[name="subscription_type"]:checked')?.value;
    const flavour1 = document.querySelector('input[name="flavour1"]:checked')?.value;
    const flavour2 = document.querySelector('input[name="flavour2"]:checked')?.value || '';

    const container = document.getElementById('variant-id-container');

    if (type === 'Double Drink Subscription') {
      const variant1 = variants.find(v => v.option1 === type && v.option2 === flavour1);
      const variant2 = variants.find(v => v.option1 === type && v.option2 === flavour2);

      container.innerHTML = `
        ${variant1 ? `<input type="hidden" name="items[][id]" value="${variant1.id}"><input type="hidden" name="items[][quantity]" value="1">` : ''}
        ${variant2 ? `<input type="hidden" name="items[][id]" value="${variant2.id}"><input type="hidden" name="items[][quantity]" value="1">` : ''}
      `;
    } else {
      const variant = variants.find(v => v.option1 === type && v.option2 === flavour1);
      container.innerHTML = variant ? `<input type="hidden" name="id" value="${variant.id}">` : '';
    }
  }

  document.querySelectorAll('input[type="radio"]').forEach(el => {
    el.addEventListener('change', () => {
      if (el.name === 'subscription_type') {
        document.querySelectorAll('.subscription-details').forEach(div => div.style.display = 'none');
        el.closest('.subscription-card-wrapper').querySelector('.subscription-details').style.display = 'block';
      }
      updateVariantID();
    });
  });

  updateVariantID();
</script>
